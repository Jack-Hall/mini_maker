<div class="puzzle-creator">
  <div class="header">
    <h1>Crossword Puzzle Creator</h1>
    <div class="header-actions">
      <button class="clear-btn" (click)="clearGrid()">Clear Grid</button>
      <button 
        class="solve-btn" 
        (click)="findSolutions()"
        [disabled]="isFindingSolutions()">
        @if (isFindingSolutions()) {
          Finding Solutions...
        } @else {
          Find Solutions
        }
      </button>
      <button class="save-btn" (click)="savePuzzle()">Save Puzzle</button>
    </div>
  </div>

  <div class="creator-container">
    <div class="top-section">
      <div class="grid-editor">
      <h3>Grid Editor</h3>
      <p class="instruction">Click cells to edit. Right-click or Ctrl+Delete to toggle black cells. Enter to toggle direction.</p>
      
      <div class="editor-grid">
        @for (row of grid(); track $index; let rowIndex = $index) {
          <div class="editor-row">
            @for (cell of row; track $index; let colIndex = $index) {
              <div 
                [class]="getCellClass(rowIndex, colIndex)"
                (click)="onCellClick(rowIndex, colIndex)"
                (contextmenu)="onCellRightClick(rowIndex, colIndex, $event)">
                @if (cell === '#') {
                  <div class="blocked-cell"></div>
                } @else {
                  <input 
                    #inputField
                    type="text" 
                    maxlength="1"
                    [value]="cell"
                    (input)="onCellInput(rowIndex, colIndex, inputField.value)"
                    (focus)="onCellFocus(rowIndex, colIndex)"
                    (keydown)="onCellKeydown(rowIndex, colIndex, $event)"
                    [attr.data-row]="rowIndex"
                    [attr.data-col]="colIndex"
                    class="cell-input">
                }
              </div>
            }
          </div>
        }
      </div>

      <!-- Pattern Matching Component -->
      @if (showPatternMatches()) {
        <div class="pattern-matches-container">
          <div class="pattern-matches-header">
            <h4>Word Suggestions for Pattern: "{{ getSelectedWord() }}"</h4>
            <button 
              class="close-pattern-btn" 
              (click)="closePatternMatches()"
              title="Close suggestions">
              ✕
            </button>
          </div>
          
          <div class="pattern-matches-content">
            @if (isLoadingPatterns()) {
              <div class="loading-pattern">
                <span>Loading word suggestions...</span>
              </div>
            } @else if (patternMatches().length > 0) {
              <div class="pattern-matches-info">
                <p>Found {{ patternMatches().length }} word{{ patternMatches().length === 1 ? '' : 's' }} that match this pattern:</p>
              </div>
              <div class="pattern-matches-list">
                @for (match of patternMatches(); track match; let i = $index) {
                  <button 
                    class="pattern-match-btn"
                    (click)="applyPatternMatchToGrid(match)"
                    title="Click to apply '{{ match }}' to the grid">
                    {{ match }}
                  </button>
                }
              </div>
            } @else {
              <div class="no-pattern-matches">
                <p>No word suggestions found for this pattern.</p>
              </div>
            }
          </div>
        </div>
      }
      
      <div class="creator-sidebar">
        <div class="info-panel">
          <h3>Puzzle Creator</h3>
          <p>This feature is currently under development.</p>
          <p>You can edit the grid above, but saving functionality will be implemented soon.</p>
          
          <div class="grid-info">
            <h4>Grid Information</h4>
            <p><strong>Size:</strong> {{ grid().length }} × {{ grid()[0].length }}</p>
            <p><strong>Total Cells:</strong> {{ grid().length * grid()[0].length }}</p>
            <p><strong>Black Cells:</strong> {{ (grid() | json).split('"#"').length - 1 }}</p>
            <p><strong>Detected Words:</strong> 
            @if (isUpdatingWords()) {
              <span class="updating">Updating...</span>
            } @else {
              {{ getDetectedWordCount() }}
            }
          </p>
            <p><strong>Direction:</strong> {{ activeDirection() === 'horizontal' ? 'Across' : 'Down' }}</p>
          </div>
          
          <div class="controls-info">
            <h4>Controls</h4>
            <ul>
              <li><strong>Right-click:</strong> Toggle black cell</li>
              <li><strong>Ctrl+Delete:</strong> Toggle black cell</li>
              <li><strong>Enter:</strong> Switch direction</li>
              <li><strong>Arrow keys:</strong> Navigate grid</li>
            </ul>
          </div>

          <div class="clue-actions">
            <h4>Clue Management</h4>
            <p class="clue-info">Clues are automatically generated when you add/remove black cells. Click to manually add more.</p>
            <button 
              class="add-clue-btn" 
              (click)="addClue()"
              [disabled]="!activeCell()">
              Add Clue for Current Word
            </button>
          </div>

          @if (allSolutions().length > 0 && currentWordPosition()) {
            <div class="word-suggestions">
              <h4>Word Suggestions</h4>
              @if (availableWords().length > 0) {
                <p class="suggestions-info">
                  Select a word for the current 
                  <strong>{{ currentWordPosition()!.direction === 'horizontal' ? 'across' : 'down' }}</strong> 
                  position ({{ currentWordPosition()!.length }} letters):
                </p>
                <div class="suggestions-container">
                  <div class="current-word-display">
                    <span class="current-word-label">Current:</span>
                    <span class="current-word-text">
                      @if (currentWordPosition()!.text) {
                        {{ currentWordPosition()!.text }}
                      } @else {
                        <em>(empty)</em>
                      }
                    </span>
                  </div>
                  <div class="suggestions-list">
                    @for (word of availableWords(); track word; let i = $index) {
                      <button 
                        class="suggestion-btn"
                        (click)="applyWordToGrid(word)"
                        [class.current-word]="word === currentWordPosition()!.text"
                        title="Click to apply this word">
                        {{ word }}
                      </button>
                    }
                  </div>
                </div>
              } @else {
                <p class="no-suggestions">No word suggestions available for this position.</p>
              }
            </div>
          }
        </div>
      </div>
    </div>
      
      <!-- Clue editing panel below the puzzle -->
      @if (acrossClues().length > 0 || downClues().length > 0) {
        <div class="clues-panel">
          <h3>Clues</h3>
          
          <div class="clues-container-below">
            @if (acrossClues().length > 0) {
              <div class="clues-section">
                <h4>Across</h4>
                <div class="clues-list">
                  @for (clue of acrossClues(); track $index) {
                    <div class="clue-item" [class.active-clue]="isClueActive(clue)" [class.editing]="isEditingClue(clue)">
                      <span class="clue-number">{{ $index + 1 }}.</span>
                      @if (isEditingClue(clue)) {
                        <input 
                          #clueInput
                          type="text" 
                          [value]="clue.clue"
                          (blur)="updateClue(clue, clueInput.value)"
                          (keydown.enter)="updateClue(clue, clueInput.value)"
                          (keydown.escape)="stopEditingClue()"
                          class="clue-edit-input"
                          autofocus>
                      } @else {
                        <span class="clue-text" (dblclick)="startEditingClue(clue)">{{ clue.clue }}</span>
                        <button 
                          class="edit-clue-btn" 
                          (click)="startEditingClue(clue)"
                          title="Edit clue">
                          ✏️
                        </button>
                      }
                    </div>
                  }
                </div>
              </div>
            }

            @if (downClues().length > 0) {
              <div class="clues-section">
                <h4>Down</h4>
                <div class="clues-list">
                  @for (clue of downClues(); track $index) {
                    <div class="clue-item" [class.active-clue]="isClueActive(clue)" [class.editing]="isEditingClue(clue)">
                      <span class="clue-number">{{ $index + 1 }}.</span>
                      @if (isEditingClue(clue)) {
                        <input 
                          #clueInput
                          type="text" 
                          [value]="clue.clue"
                          (blur)="updateClue(clue, clueInput.value)"
                          (keydown.enter)="updateClue(clue, clueInput.value)"
                          (keydown.escape)="stopEditingClue()"
                          class="clue-edit-input"
                          autofocus>
                      } @else {
                        <span class="clue-text" (dblclick)="startEditingClue(clue)">{{ clue.clue }}</span>
                        <button 
                          class="edit-clue-btn" 
                          (click)="startEditingClue(clue)"
                          title="Edit clue">
                          ✏️
                        </button>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>

          @if (activeClue()) {
            <div class="selected-clue">
              <strong>Active:</strong>
              <span class="selected-clue-direction">{{ activeClue()!.direction === 'horizontal' ? 'Across' : 'Down' }}</span>
              <span class="selected-clue-text">{{ activeClue()!.clue }}</span>
            </div>
          }
        </div>
      }

      <!-- Solutions display panel -->
      @if (foundSolutions().length > 0) {
        <div class="solutions-panel">
          <div class="solutions-header">
            <h3>Found Solutions</h3>
            <div class="solutions-info">
              <span class="solution-count">
                Showing {{ foundSolutions().length }} of {{ allSolutions().length }} solutions
              </span>
              @if (selectedWords().length > 0) {
                <button class="clear-selection-btn" (click)="clearSelectedWords()">
                  Clear Selections ({{ selectedWords().length }})
                </button>
              }
            </div>
          </div>
          
          @if (selectedWords().length > 0) {
            <div class="selected-words-panel">
              <h4>Selected Words:</h4>
              <div class="selected-words-list">
                @for (selectedWord of selectedWords(); track $index) {
                  <span class="selected-word-item">
                    <strong>{{ selectedWord.text }}</strong>
                    <small>({{ selectedWord.position.direction }})</small>
                  </span>
                }
              </div>
            </div>
          }

          <div class="solutions-container">
            @for (solution of foundSolutions(); track $index; let solutionIndex = $index) {
              <div class="solution-item">
                <div class="solution-header">
                  <h4>Solution {{ solutionIndex + 1 }}</h4>
                  <button 
                    class="apply-solution-btn" 
                    (click)="applySolution(solution)"
                    title="Apply this solution to the grid">
                    Apply Solution
                  </button>
                </div>
                <div class="solution-grid-container">
                  <div class="solution-grid">
                    @for (row of solution; track $index; let rowIndex = $index) {
                      <div class="solution-row">
                        @for (cell of row; track $index; let colIndex = $index) {
                          <div class="solution-cell" [class.blocked]="cell === '#'">
                            {{ cell === '#' ? '' : cell }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                  <div class="solution-words">
                    <h5>Click words to filter solutions:</h5>
                    <div class="words-list">
                      @for (word of getWordsFromSolution(solution); track $index) {
                        <button 
                          [class]="getWordClass(word, solution)"
                          (click)="selectWord(word, solution)"
                          title="Click to select/deselect this word">
                          <span class="word-text">{{ word.text }}</span>
                          <span class="word-direction">({{ word.direction === 'horizontal' ? 'Across' : 'Down' }})</span>
                        </button>
                      }
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      @if (solutionError()) {
        <div class="error-panel">
          <h3>Error Finding Solutions</h3>
          <p class="error-message">{{ solutionError() }}</p>
          <button class="retry-btn" (click)="findSolutions()">Try Again</button>
        </div>
      }
  </div>
</div> 